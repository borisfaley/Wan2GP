# CLAUDE.md

Этот файл содержит руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

## Обзор проекта

WanGP — это оптимизированный для GPU фреймворк генерации видео, поддерживающий 50+ AI-моделей (Wan, Hunyuan Video, LTX Video, Flux, Qwen и др.) с минимальными требованиями к VRAM (от 6 ГБ). Проект предоставляет веб-интерфейс на базе Gradio через `wgp.py` (~10 600 строк) как основную точку входа.

## Основные команды

```bash
# Запуск приложения (веб-интерфейс на http://localhost:7860)
python wgp.py

# Пакетная обработка без интерфейса
python wgp.py --process my_queue.zip
python wgp.py --process my_settings.json

# Проверка без генерации
python wgp.py --process my_queue.zip --dry-run

# Сервер с сетевым доступом
python wgp.py --listen --server-port 8080

# Опции производительности
python wgp.py --attention sage2 --profile 4    # Рекомендуемые настройки
python wgp.py --compile --attention sage2 --profile 3  # Высокая производительность

# Обновление
git pull && pip install -r requirements.txt
```

## Архитектура

### Основная структура
- **wgp.py** — главное приложение, Gradio UI, управление очередью, оркестрация моделей
- **models/** — реализации моделей по семействам (wan/, flux/, hyvideo/, ltx_video/, qwen/ и др.)
- **shared/** — базовые утилиты и общие компоненты
  - **utils/** — 24+ модуля утилит (audio_video.py, plugins.py, loras_multipliers.py, prompt_parser.py и др.)
  - **attention.py** — управление режимами внимания (SDPA, Flash, Sage, Sage2)
  - **sage2_core.py** — интеграция SageAttention для оптимизации GPU
- **preprocessing/** — обработка входных данных (matanyone, dwpose, depth_anything_v2, face_preprocessor.py и др.)
- **postprocessing/** — улучшение результатов (mmaudio, rife, film_grain.py)
- **plugins/** — расширяемая система плагинов

### Система плагинов
Плагины расширяют функциональность без изменения основного кода. Каждый плагин — это пакет в `plugins/` с файлами:
- `__init__.py` (пустой, помечает как пакет)
- `plugin.py` (основной класс, наследующий `WAN2GPPlugin`)
- `requirements.txt` (опциональные зависимости)

Ключевые методы API плагинов:
- `setup_ui()` — объявление вкладок, запрос компонентов/глобальных переменных
- `post_ui_setup(components)` — подключение событий, внедрение UI-элементов
- `self.add_tab()`, `self.request_component()`, `self.insert_after()`, `self.set_global()`

См. `plugins/wan2gp-sample/` для примера реализации.

### Профили памяти
- **Профиль 1**: HighRAM_HighVRAM (48+ ГБ RAM, 24+ ГБ VRAM)
- **Профиль 2**: HighRAM_LowVRAM (48+ ГБ RAM, 12+ ГБ VRAM)
- **Профиль 3**: LowRAM_HighVRAM (32+ ГБ RAM, 24+ ГБ VRAM)
- **Профиль 4**: По умолчанию — загрузка частей модели по мере необходимости, максимальная гибкость
- **Профиль 5**: VeryLowRAM_LowVRAM (16+ ГБ RAM, 10+ ГБ VRAM)

### Файлы конфигурации
- `wgp_config.json` — пользовательские настройки (создаётся автоматически)
- `plugins.json` — манифест установленных плагинов
- `defaults/` — предустановленные настройки моделей (JSON-файлы)
- `profiles/` — профили памяти/производительности

## Ключевые зависимости

- **PyTorch 2.7.1** с CUDA 12.8 (рекомендуется)
- **MMGP 3.6.9** — обязательно именно эта версия (проверяется при запуске)
- **Gradio 5.29.0** — фреймворк веб-интерфейса
- **Diffusers 0.34.0**, **Transformers 4.53.1** — инфраструктура AI-моделей

## Заметки для разработки

- Потокобезопасность критична — используется `threading.Lock` для управления очередью и моделями
- Автоопределение архитектуры GPU поддерживает от GTX 10XX до RTX 50XX
- Модели автоматически загружаются с HuggingFace с адаптацией под оборудование
- Метаданные встраиваются в сгенерированные видео/изображения для воспроизводимости
- Кодовая база сфокусирована на оптимизации VRAM (квантизация, выгрузка, профилирование памяти)
